# ì œì•½ ì¡°ê±´ ì •ì˜ì™€ ì¸ë±ìŠ¤ ì„¤ê³„ (Constraints and Index Design)
## ğŸ“˜ í•™ìŠµ ê°œìš”

ë…¼ë¦¬ ì„¤ê³„ì—ì„œëŠ” â€œì–´ë–¤ ë°ì´í„°ê°€ í•„ìš”í•œê°€â€ë¥¼ ì •ì˜í–ˆë‹¤ë©´,
ë¬¼ë¦¬ ì„¤ê³„ì—ì„œëŠ” â€œê·¸ ë°ì´í„°ë¥¼ ì–´ë–¤ ê·œì¹™ìœ¼ë¡œ ì €ì¥í•˜ê³ , ì–´ë–»ê²Œ ë¹ ë¥´ê²Œ ì°¾ì„ ê²ƒì¸ê°€â€ë¥¼ ê²°ì •í•œë‹¤.

ì œì•½ ì¡°ê±´ê³¼ ì¸ë±ìŠ¤ëŠ”
ë¬¼ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ì˜ í•µì‹¬ ìš”ì†Œì´ë©°,
ì˜ëª» ì„¤ê³„í•˜ë©´ ë°ì´í„° ì˜¤ë¥˜ì™€ ì„±ëŠ¥ ë¬¸ì œë¥¼ ë™ì‹œì— ìœ ë°œí•œë‹¤.

## ğŸ’¡ ì£¼ìš” ë‚´ìš©

- ì œì•½ ì¡°ê±´ì˜ ì—­í• ê³¼ ì¢…ë¥˜

- NOT NULL, UNIQUE, PRIMARY KEY

- ì œì•½ ì¡°ê±´ê³¼ ë°ì´í„° ë¬´ê²°ì„±

- ì¸ë±ìŠ¤ì˜ ê°œë…ê³¼ í•„ìš”ì„±

- PK ì¸ë±ìŠ¤ì™€ ë³´ì¡° ì¸ë±ìŠ¤ ì„¤ê³„ ê¸°ì¤€

--- 


# 1. ì œì•½ ì¡°ê±´ì´ë€ ë¬´ì—‡ì¸ê°€
## 1-1. ì œì•½ ì¡°ê±´ì˜ ê°œë…

ì œì•½ ì¡°ê±´(Constraint)ì€
í…Œì´ë¸”ì— ì €ì¥ë˜ëŠ” ë°ì´í„°ê°€ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ê·œì¹™ì´ë‹¤.

ì œì•½ ì¡°ê±´ì´ ì—†ëŠ” í…Œì´ë¸”ì€
í˜•ì‹ì€ í…Œì´ë¸”ì´ì§€ë§Œ,
ì–´ë–¤ ê°’ì´ ë“¤ì–´ì™€ë„ ì˜¤ë¥˜ ì—†ì´ ì €ì¥ë˜ëŠ”, ê·œì¹™ ì—†ëŠ” ì €ì¥ì†Œì— ê°€ê¹ë‹¤.

ì¦‰,
ì œì•½ ì¡°ê±´ì€ ë°ì´í„°ì˜ ìµœì†Œí•œì˜ í’ˆì§ˆ ê¸°ì¤€ì„ ë°ì´í„°ë² ì´ìŠ¤ ì°¨ì›ì—ì„œ ë³´ì¥í•œë‹¤.

## 1-2. ì œì•½ ì¡°ê±´ì´ í•„ìš”í•œ ì´ìœ 

> ì œì•½ ì¡°ê±´ì´ í•„ìš”í•œ ì´ìœ ëŠ” ë°ì´í„° ì˜¤ë¥˜ë¥¼ ì‚¬í›„ì— ì²˜ë¦¬í•˜ì§€ ì•Šê¸° ìœ„í•´ì„œì´ë‹¤.

- ì˜ëª»ëœ ë°ì´í„° ì…ë ¥ì„ ì €ì¥ ë‹¨ê³„ì—ì„œ ì¦‰ì‹œ ì°¨ë‹¨

- ëª¨ë“  í–‰ì´ ë™ì¼í•œ ê·œì¹™ì„ ë”°ë¥´ë„ë¡ í•˜ì—¬ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€

- ê²€ì¦ ë¡œì§ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ë§ˆë‹¤ ë°˜ë³µ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ë˜ì–´ ì½”ë“œ ì˜ì¡´ë„ ê°ì†Œ

- ì–´ë–¤ í”„ë¡œê·¸ë¨ì´ ì ‘ê·¼í•˜ë”ë¼ë„ ê·œì¹™ì´ ìœ ì§€ë˜ì–´ ë°ì´í„°ë² ì´ìŠ¤ ìì²´ì˜ ì‹ ë¢°ì„± í™•ë³´

ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œë§Œ ê²€ì¦í•  ê²½ìš°,
ì—¬ëŸ¬ ì„œë¹„ìŠ¤Â·ë°°ì¹˜Â·ê´€ë¦¬ ë„êµ¬ì—ì„œ
ê°™ì€ ê²€ì¦ ë¡œì§ì„ ê°ê° êµ¬í˜„í•´ì•¼ í•œë‹¤.

ì œì•½ ì¡°ê±´ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì •ì˜í•˜ë©´,
ì–´ë–¤ ê²½ë¡œë¡œ ë°ì´í„°ê°€ ì €ì¥ë˜ë”ë¼ë„
í•­ìƒ ë™ì¼í•œ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ë¬´ê²°ì„±ì´ ë³´ì¥ëœë‹¤.

ë”°ë¼ì„œ ì œì•½ ì¡°ê±´ì€
ë¬¸ì œê°€ ë°œìƒí•œ ë’¤ì— ìˆ˜ì •í•˜ëŠ” ìˆ˜ë‹¨ì´ ì•„ë‹ˆë¼,
ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë¯¸ë¦¬ ì°¨ë‹¨í•˜ëŠ” ì˜ˆë°© ì¥ì¹˜ì´ë‹¤.

--- 

# 2. ì£¼ìš” ì œì•½ ì¡°ê±´ ì¢…ë¥˜
## 2-1. PRIMARY KEY

> PKëŠ” ì‚¬ëŒì´ ì´í•´í•˜ë ¤ê³  ì“°ëŠ” ê°’ì´ ì•„ë‹ˆë¼, DBê°€ ë¹ ë¥´ê³  ì•ˆì „í•˜ê²Œ êµ¬ë¶„í•˜ë ¤ê³  ì“°ëŠ” ë²ˆí˜¸ë‹¤.   
> í…Œì´ë¸”ì˜ ê° í–‰ì„ ìœ ì¼í•˜ê²Œ ì‹ë³„í•˜ëŠ” ì»¬ëŸ¼

íŠ¹ì§•:

- NOT NULL

- UNIQUE

- í…Œì´ë¸” ë‹¹ í•˜ë‚˜ë§Œ ì¡´ì¬

- ìë™ìœ¼ë¡œ ì¸ë±ìŠ¤ ìƒì„±

ì˜ˆì‹œ:
```sql
id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY
```



## 2-2. UNIQUE

> UNIQUE ì œì•½ì€ íŠ¹ì • ì»¬ëŸ¼ì˜ ê°’ì´ í…Œì´ë¸” ë‚´ì—ì„œ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ë³´ì¥í•˜ëŠ” ì œì•½ ì¡°ê±´ì´ë‹¤.

ëŒ€í‘œì ì¸ ì‚¬ìš© ì˜ˆ:

- ì´ë©”ì¼

- ë¡œê·¸ì¸ ì•„ì´ë””

- íœ´ëŒ€í° ë²ˆí˜¸


íŠ¹ì§•:

- UNIQUE ì»¬ëŸ¼ì€ NULLì„ ì—¬ëŸ¬ ê°œ í—ˆìš©í•  ìˆ˜ ìˆë‹¤

- ì¤‘ë³µ ë°©ì§€ê°€ ëª©ì ì´ë©´ UNIQUE ì œì•½ ì¡°ê±´ì„ ì‚¬ìš©í•œë‹¤

ì˜ˆì‹œ:
```sql
email VARCHAR(100) UNIQUE
```

---

# 3. ì¸ë±ìŠ¤ë€ ë¬´ì—‡ì¸ê°€

## 3-1. ì¸ë±ìŠ¤ ê°œë…
> ì¸ë±ìŠ¤(Index)ëŠ” ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì¡°íšŒí•˜ê¸° ìœ„í•´ ì •ë ¬ëœ ìë£Œ êµ¬ì¡°(B+Tree) ë¥¼ ì‚¬ìš©í•œë‹¤.   
> B+TreeëŠ” â€œì–´ë””ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€â€ë¥¼ ë¹ ë¥´ê²Œ ì°¾ëŠ” ì§€ë„ë‹¤.

ì¸ë±ìŠ¤ê°€ ì—†ìœ¼ë©´:

- í…Œì´ë¸” ì „ì²´ë¥¼ ìˆœì°¨ íƒìƒ‰

ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©´:

- í•„ìš”í•œ ìœ„ì¹˜ë¡œ ë°”ë¡œ ì ‘ê·¼

B+Tree êµ¬ì¡°


## 3-2. ì¸ë±ìŠ¤ì˜ ì¥ë‹¨ì 

ì¥ì :

- ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ

- JOIN ì„±ëŠ¥ í–¥ìƒ

- ORDER BY, GROUP BY ìµœì í™”

ë‹¨ì :

- ì €ì¥ ê³µê°„ ì¶”ê°€ ì‚¬ìš©

- INSERT, UPDATE, DELETE ì„±ëŠ¥ ì €í•˜

ë”°ë¼ì„œ ì¸ë±ìŠ¤ëŠ” ì „ëµì ìœ¼ë¡œ ì„¤ê³„í•´ì•¼ í•œë‹¤.

--- 

# 4. ê¸°ë³¸ í‚¤ ì¸ë±ìŠ¤ (PK ì¸ë±ìŠ¤)
## 4-1. PK ì¸ë±ìŠ¤ íŠ¹ì§•

> PRIMARY KEYëŠ” ìë™ìœ¼ë¡œ ì¸ë±ìŠ¤ê°€ ìƒì„±ëœë‹¤.

- ì¤‘ë³µ ë¶ˆê°€

- NULL ë¶ˆê°€

- InnoDBì—ì„œëŠ” í´ëŸ¬ìŠ¤í„°ë“œ ì¸ë±ìŠ¤    
  ( í´ëŸ¬ìŠ¤í„°ë“œ ì¸ë±ìŠ¤ë€ í…Œì´ë¸” ë°ì´í„° ìì²´ê°€ PK ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë˜ì–´ ì €ì¥ë˜ëŠ” êµ¬ì¡°ì´ë‹¤. )

## 4-2. PK ì„¤ê³„ ê¸°ì¤€

- ê°’ì´ ë³€í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤

- ê¸¸ì´ê°€ ì§§ì„ìˆ˜ë¡ ì¢‹ë‹¤

- ìˆ«ìí˜• AUTO_INCREMENT ê¶Œì¥

ë¹„ê¶Œì¥ ì˜ˆ:

- ì´ë©”ì¼

- ì£¼ë¯¼ë²ˆí˜¸

- ì˜ë¯¸ ìˆëŠ” ì½”ë“œ

--- 

# 5. ë³´ì¡° ì¸ë±ìŠ¤ (Secondary Index)
## 5-1. ë³´ì¡° ì¸ë±ìŠ¤ë€

> PRIMARY KEYë¥¼ ì œì™¸í•œ ëª¨ë“  ì¸ë±ìŠ¤ë¥¼ ë³´ì¡° ì¸ë±ìŠ¤ë¼ê³  í•œë‹¤.  
> ë³´ì¡° ì¸ë±ìŠ¤(Secondary Index)ëŠ” ì¸ë±ìŠ¤ë¥¼ í†µí•´ PK ê°’ì„ ì°¾ê³ , PK(í´ëŸ¬ìŠ¤í„°ë“œ ì¸ë±ìŠ¤)ë¥¼ í†µí•´ ì‹¤ì œ ë ˆì½”ë“œë¥¼ ì°¾ëŠ”ë‹¤.

ì£¼ ì‚¬ìš© ëª©ì :

- WHERE ì¡°ê±´ ê²€ìƒ‰

- JOIN ì„±ëŠ¥ í–¥ìƒ

- ì •ë ¬ ì„±ëŠ¥ ê°œì„ 

## 5-2. ë³´ì¡° ì¸ë±ìŠ¤ ì„¤ê³„ ëŒ€ìƒ

ë‹¤ìŒ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì»¬ëŸ¼ì— ì£¼ë¡œ ìƒì„±í•œë‹¤.

- ì¡°íšŒê°€ ë§¤ìš° ì¦ì€ ì»¬ëŸ¼

- JOIN ì¡°ê±´ì— ìì£¼ ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼

- ORDER BY, GROUP BYì— ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼

## 5-3. ë³´ì¡° ì¸ë±ìŠ¤ ì˜ˆì‹œ

ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ ì¿¼ë¦¬:
```sql
SELECT *
FROM posts
WHERE user_id = 10
ORDER BY created_at DESC
LIMIT 10;
```

ì¶”ì²œ ì¸ë±ìŠ¤:
```sql
CREATE INDEX idx_posts_user_created
ON posts(user_id, created_at);
```

## 5-4. ë³µí•© ì¸ë±ìŠ¤ ì»¬ëŸ¼ ìˆœì„œ ê·œì¹™

ë³µí•© ì¸ë±ìŠ¤ëŠ” ì™¼ìª½ ì»¬ëŸ¼ë¶€í„° ì‚¬ìš©ëœë‹¤.

ì¸ë±ìŠ¤ (A, B)

- WHERE A = ? ê°€ëŠ¥

- WHERE A = ? AND B = ? ê°€ëŠ¥

- WHERE B = ? ë§Œ ì‚¬ìš©í•˜ë©´ ì¸ë±ìŠ¤ ì‚¬ìš© ë¶ˆê°€





--- 

# 6. ì œì•½ ì¡°ê±´ê³¼ ì¸ë±ìŠ¤ ê´€ê³„ ì •ë¦¬

## 6-1. ì œì•½ ì¡°ê±´ ì •ë¦¬

> ì œì•½ ì¡°ê±´ì€ ë°ì´í„°ê°€ ì €ì¥ë  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ê²°ì •í•œë‹¤.

| ì œì•½ ì¡°ê±´       | ì—­í•       | ë³´ì¥í•˜ëŠ” ê²ƒ        | ì¸ë±ìŠ¤ ìƒì„±    |
| ----------- | ------- | ------------- | --------- |
| PRIMARY KEY | í–‰ ì‹ë³„    | ìœ ì¼ì„± + NULL ë¶ˆê°€ | ìë™ ìƒì„±     |
| UNIQUE      | ì¤‘ë³µ ë°©ì§€   | ê°’ ì¤‘ë³µ ê¸ˆì§€       | ìë™ ìƒì„±     |
| NOT NULL    | í•„ìˆ˜ ê°’    | NULL ì…ë ¥ ì°¨ë‹¨    | ìƒì„± ì•ˆ ë¨    |

## 6-2. ì¸ë±ìŠ¤ ì •ë¦¬
> ì¸ë±ìŠ¤ëŠ” ì–´ë””ë¥¼ ë¹¨ë¦¬ ì°¾ì„ ê²ƒì¸ê°€ë¥¼ ê²°ì •í•œë‹¤.

| ì¸ë±ìŠ¤ ì¢…ë¥˜          | ì—­í•          | íŠ¹ì§•        | ê°œìˆ˜      |
| --------------- | ---------- | --------- | ------- |
| PRIMARY KEY ì¸ë±ìŠ¤ | ê¸°ë³¸ ì¡°íšŒ ê¸°ì¤€   | í´ëŸ¬ìŠ¤í„°ë“œ ì¸ë±ìŠ¤ | í…Œì´ë¸”ë‹¹ 1ê°œ |
| UNIQUE ì¸ë±ìŠ¤      | ì¤‘ë³µ ê²€ì‚¬ + ì¡°íšŒ | ë³´ì¡° ì¸ë±ìŠ¤    | ì—¬ëŸ¬ ê°œ ê°€ëŠ¥ |
| ë³´ì¡° ì¸ë±ìŠ¤          | ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ   | ë…¼í´ëŸ¬ìŠ¤í„°ë“œ    | ì—¬ëŸ¬ ê°œ ê°€ëŠ¥ |
| ë³µí•© ì¸ë±ìŠ¤          | ë‹¤ì¤‘ ì¡°ê±´ ìµœì í™”  | ì»¬ëŸ¼ ìˆœì„œ ì¤‘ìš”  | ì—¬ëŸ¬ ê°œ ê°€ëŠ¥ |


## 6-3. PRIMARY KEY ì¸ë±ìŠ¤ì™€ ë³´ì¡° ì¸ë±ìŠ¤ êµ¬ì¡° ë¹„êµ
| êµ¬ë¶„        | PRIMARY KEY ì¸ë±ìŠ¤ | ë³´ì¡° ì¸ë±ìŠ¤      |
| --------- | --------------- | ----------- |
| ì¸ë±ìŠ¤ ìœ í˜•    | í´ëŸ¬ìŠ¤í„°ë“œ           | ë…¼í´ëŸ¬ìŠ¤í„°ë“œ      |
| ì‹¤ì œ ë°ì´í„° í¬í•¨ | í¬í•¨í•¨             | í¬í•¨ ì•ˆ í•¨      |
| ì €ì¥ êµ¬ì¡°     | PK + ì „ì²´ row     | ì¸ë±ìŠ¤ ì»¬ëŸ¼ + PK |
| ì¡°íšŒ ë‹¨ê³„     | 1ë‹¨ê³„             | 2ë‹¨ê³„         |
| ì„¤ê³„ ì¤‘ìš”ë„    | ë§¤ìš° ë†’ìŒ           | ìƒí™©ë³„ íŒë‹¨      |

---

# ğŸ§© ì‹¤ìŠµ / ê³¼ì œ


## 1. ì œì•½ ì¡°ê±´ì´ ì—†ëŠ” í…Œì´ë¸”ì˜ ë¬¸ì œì  ì²´í—˜

### 1-1. ì œì•½ ì¡°ê±´ ì—†ëŠ” í…Œì´ë¸” ìƒì„±
```sql
CREATE TABLE users_test (
    id INT,
    email VARCHAR(100),
    username VARCHAR(50)
);
```

### 1-2. ì˜ëª»ëœ ë°ì´í„° ì‚½ì…
```sql
INSERT INTO users_test VALUES
(NULL, NULL, NULL),
(1, 'a@test.com', 'kim'),
(1, 'a@test.com', 'lee'),
(1, 'b@test.com', 'park');
```


## 2. ì œì•½ ì¡°ê±´ ì ìš© í›„ ë°ì´í„° ì°¨ë‹¨ í™•ì¸


### 2-1. ì œì•½ ì¡°ê±´ê³¼ í•¨ê¼ í…Œì´ë¸” ìƒì„±
```sql
CREATE TABLE users_raw (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    username VARCHAR(50) NOT NULL
);
```

### 2-2. ë°ì´í„° ì‚½ì…
```sql
INSERT INTO users_raw (email, username) VALUES
('a@test.com', 'kim'),
('a@test.com', 'lee');
```


## 3. ë³´ì¡° ì¸ë±ìŠ¤ ì—†ì„ ë•Œ vs ìˆì„ ë•Œ ë¹„êµ

### 3-1. posts í…Œì´ë¸” ë³´ì¡° ì¸ë±ìŠ¤ ( idx_posts_user_created ) ì‚­ì œ

### 3-2. ë”ë¯¸ ë°ì´í„° insert
```sql
sudo mysql testdb < posts_100k_dump.sql
```

### (ì°¸ê³ ) í…Œì´ë¸” dump
```sql
sudo mysqldump testdb posts --no-create-info > posts_insert_only.sql
```


### 3-2. ì•„ë˜ ì¿¼ë¦¬ ì‹¤í–‰
```sql
SELECT * FROM testdb.posts where user_id = 100 order by created_at desc
```


### 3-3. ì¿¼ë¦¬ê°€ ì¸ë±ìŠ¤ ì‚¬ìš©í•˜ëŠ”ì§€ 
```sql
explain SELECT * FROM testdb.posts where user_id = 100 order by created_at desc
```


### 3-4. user_id, created_at ë³µí•© ì¸ë±ìŠ¤ ìƒì„± í›„ ì‹¤í–‰ê²°ê³¼ ë³´ê¸°
```sql
explain SELECT * FROM testdb.posts where user_id = 100 order by created_at desc

SELECT * FROM testdb.posts where user_id = 100 order by created_at desc
```